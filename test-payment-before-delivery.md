# اختبار منع التسليم قبل سداد المبلغ المتبقي

## المشكلة الأصلية
كان النظام يسمح بتسليم الطلبات للعملاء حتى لو كان هناك مبلغ متبقي غير مسدد.

## الحل المطبق

### 1. **إضافة التحقق من المبلغ المتبقي قبل التسليم**
```typescript
// في دالة handleMarkAsDelivered
const remainingAmount = orderData.remainingAmount || 0;
if (remainingAmount > 0) {
  toast({ 
    title: effectiveLang === 'ar' ? 'لا يمكن التسليم' : 'Cannot Deliver',
    description: effectiveLang === 'ar' 
      ? `يجب سداد المبلغ المتبقي (${remainingAmount.toFixed(2)} ريال) قبل التسليم`
      : `Remaining amount (${remainingAmount.toFixed(2)} SAR) must be paid before delivery`,
    variant: 'destructive' 
  });
  return;
}
```

### 2. **إضافة عمود المبلغ المتبقي في جدول التسليم**
- عرض المبلغ المتبقي بلون أحمر إذا كان أكبر من صفر
- عرض "مسدد بالكامل" بلون أخضر إذا لم يكن هناك مبلغ متبقي

### 3. **تعطيل زر التسليم للطلبات غير المسددة**
- الزر يصبح رمادي ومعطل إذا كان هناك مبلغ متبقي
- إضافة tooltip يوضح السبب

### 4. **إضافة زر "إضافة دفعة" للطلبات غير المسددة**
- زر يوجه المستخدم لصفحة تفاصيل الطلب لإضافة دفعة
- يظهر فقط للطلبات التي لها مبلغ متبقي

## الملفات المعدلة
1. `src/app/[lang]/orders/prepare/page.tsx` - إضافة التحقق من المبلغ المتبقي
2. `src/components/orders/DeliverOrdersTable.tsx` - تحسين واجهة الجدول

## كيفية الاختبار

### 1. **اختبار طلب مسدد بالكامل**
1. انتقل إلى صفحة التحضير والتسليم
2. ابحث عن طلب مسدد بالكامل (remainingAmount = 0)
3. تأكد من:
   - ظهور "مسدد بالكامل" بلون أخضر
   - زر التسليم نشط ويعمل
   - عدم ظهور زر "إضافة دفعة"

### 2. **اختبار طلب غير مسدد بالكامل**
1. انتقل إلى صفحة التحضير والتسليم
2. ابحث عن طلب له مبلغ متبقي (remainingAmount > 0)
3. تأكد من:
   - ظهور المبلغ المتبقي بلون أحمر
   - زر التسليم معطل ورمادي
   - ظهور tooltip عند hover على زر التسليم
   - ظهور زر "إضافة دفعة" الأزرق
   - عند الضغط على زر التسليم، ظهور رسالة خطأ

### 3. **اختبار إضافة دفعة**
1. اضغط على زر "إضافة دفعة" لطلب غير مسدد
2. تأكد من الانتقال لصفحة تفاصيل الطلب
3. أضف دفعة تغطي المبلغ المتبقي
4. ارجع لصفحة التحضير والتسليم
5. تأكد من تحديث حالة الطلب وتفعيل زر التسليم

### 4. **اختبار محاولة التسليم مع مبلغ متبقي**
1. حاول الضغط على زر التسليم لطلب غير مسدد (إذا لم يكن معطلاً)
2. تأكد من ظهور رسالة خطأ واضحة
3. تأكد من عدم تغيير حالة الطلب

## السيناريوهات المختلفة

### سيناريو 1: طلب جديد بدفعة جزئية
- المبلغ الإجمالي: 1000 ريال
- المبلغ المدفوع: 500 ريال
- المبلغ المتبقي: 500 ريال
- **النتيجة المتوقعة**: لا يمكن التسليم حتى يتم سداد الـ 500 ريال المتبقية

### سيناريو 2: طلب مع خصم
- المبلغ الإجمالي: 1000 ريال
- خصم مطبق: 100 ريال
- المبلغ المدفوع: 800 ريال
- المبلغ المتبقي: 100 ريال
- **النتيجة المتوقعة**: لا يمكن التسليم حتى يتم سداد الـ 100 ريال المتبقية

### سيناريو 3: طلب مسدد بالكامل
- المبلغ الإجمالي: 1000 ريال
- المبلغ المدفوع: 1000 ريال
- المبلغ المتبقي: 0 ريال
- **النتيجة المتوقعة**: يمكن التسليم فوراً

## الفوائد
1. **حماية مالية**: منع تسليم الطلبات قبل استلام كامل المبلغ
2. **وضوح في الواجهة**: عرض واضح للمبلغ المتبقي وحالة السداد
3. **سهولة الاستخدام**: زر مباشر لإضافة دفعة
4. **منع الأخطاء**: تعطيل الإجراءات غير المسموحة

## ملاحظات مهمة
- هذا التغيير يؤثر فقط على عملية التسليم وليس على التحضير
- يمكن تحضير الطلب حتى لو لم يكن مسدداً بالكامل
- التسليم فقط هو المحظور حتى السداد الكامل
- الخصومات تؤخذ في الاعتبار عند حساب المبلغ المتبقي
